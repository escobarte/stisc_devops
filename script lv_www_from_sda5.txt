#!/bin/bash

set -e

DISK="/dev/sda"
PART="${DISK}5"
VG_NAME="vg_app"
LV_NAME="lv_www"
LV_SIZE="5G"
MOUNT_POINT="/var/www"
FSTAB_FILE="/etc/fstab"

echo "üß± –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª $PART –Ω–∞ $DISK..."

# –ó–∞–ø—É—Å–∫–∞–µ–º fdisk –∏ —Å–æ–∑–¥–∞–µ–º sda5
sudo fdisk "$DISK" <<EOF
n
5


t
5
8e
w
EOF

# –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–∞–∑–¥–µ–ª–æ–≤
sudo partprobe
sleep 2

echo "üíΩ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ LVM: pv ‚Üí vg ‚Üí lv..."

# –°–æ–∑–¥–∞—ë–º LVM
sudo pvcreate "$PART"
sudo vgcreate "$VG_NAME" "$PART"
sudo lvcreate -n "$LV_NAME" -L "$LV_SIZE" "$VG_NAME"

# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ ext4
sudo mkfs.ext4 "/dev/$VG_NAME/$LV_NAME"

# –°–æ–∑–¥–∞—ë–º —Ç–æ—á–∫—É –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
sudo mkdir -p "$MOUNT_POINT"

# –î–æ–±–∞–≤–ª—è–µ–º –≤ fstab, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ
FSTAB_ENTRY="/dev/$VG_NAME/$LV_NAME $MOUNT_POINT ext4 defaults 0 2"
if ! grep -q "$FSTAB_ENTRY" "$FSTAB_FILE"; then
    echo "$FSTAB_ENTRY" | sudo tee -a "$FSTAB_FILE"
fi

# –ú–æ–Ω—Ç–∏—Ä—É–µ–º
sudo mount -a

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! $MOUNT_POINT —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LVM-—Ç–æ–º —Ä–∞–∑–º–µ—Ä–æ–º $LV_SIZE"
